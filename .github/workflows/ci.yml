name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Frontend integration tests (no backend required)
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Run frontend integration tests
      run: bun test tests/integration/role-distribution.test.js
    
    - name: Test summary
      run: echo "✅ Frontend tests passed"

  # E2E tests with Rust backend
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Install frontend dependencies
      run: bun install
    
    - name: Build Rust backend
      run: |
        cd server-rs
        cargo build --release
    
    - name: Start Docker services
      run: |
        docker compose -f docker-compose.test.yml up -d postgres
        echo "Waiting for PostgreSQL..."
        sleep 10
    
    - name: Run Rust backend
      run: |
        cd server-rs
        cp .env.example .env
        echo "DATABASE_URL=postgresql://testuser:testpass@localhost:5433/grimkeeper_test" >> .env
        ./target/release/grimlive-server &
        sleep 5
    
    - name: Check backend health
      run: |
        curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:8001/health
    
    - name: Run E2E tests
      env:
        GRIMLIVE_API_URL: http://localhost:8001
        TEST_DATABASE_URL: postgresql://testuser:testpass@localhost:5433/grimkeeper_test
      run: bun test --verbose tests/e2e/real-integration.test.js
    
    - name: Show backend logs on failure
      if: failure()
      run: |
        ps aux | grep grimlive-server || echo "Backend not running"
    
    - name: Cleanup
      if: always()
      run: |
        pkill grimlive-server || true
        docker compose -f docker-compose.test.yml down -v

  # Linting
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Run ESLint
      run: bun run lint
    
    - name: Check formatting
      run: |
        echo "✅ Linting passed"
