name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Fast unit/integration tests (no database required)
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Run unit tests
      run: bun test tests/unit/
    
    - name: Run integration tests
      run: bun test tests/integration/role-distribution.test.js
    
    - name: Test summary
      run: echo "✅ Unit and integration tests passed"

  # E2E tests with Docker (slower but comprehensive)
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Start Docker services
      run: |
        docker compose -f docker-compose.test.yml up -d
        echo "Waiting for services to start..."
        sleep 15
    
    - name: Check Docker service status
      run: |
        docker compose -f docker-compose.test.yml ps
        docker compose -f docker-compose.test.yml logs grimlive --tail=50
    
    - name: Check service health
      run: |
        curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:8001/health
    
    - name: Run E2E tests
      env:
        GRIMLIVE_API_URL: http://localhost:8001
        TEST_DATABASE_URL: postgresql://testuser:testpass@localhost:5433/grimkeeper_test
      run: bun test --verbose tests/e2e/real-integration.test.js
    
    - name: Show logs on failure
      if: failure()
      run: |
        docker compose -f docker-compose.test.yml logs
    
    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.test.yml down -v

  # Linting and code quality
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Check for syntax errors
      run: |
        # Check all JS files compile
        bun build server/index.js --target=bun --outfile=/tmp/index.check.js
        echo "✅ No syntax errors found"
