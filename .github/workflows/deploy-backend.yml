name: Deploy Rust Backend to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm deployment to production'
        required: true
        default: ''

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'deploy'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Build Rust backend (release)
      run: |
        cd server-rs
        cargo build --release
        strip target/release/grimlive-server
        ls -lh target/release/grimlive-server
    
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H botserver >> ~/.ssh/known_hosts || true
    
    - name: Configure SSH alias
      run: |
        cat >> ~/.ssh/config << 'EOF'
        Host botserver
          HostName ${{ secrets.SERVER_HOST }}
          User ${{ secrets.SERVER_USER }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
        EOF
        chmod 600 ~/.ssh/config
    
    - name: Deploy binary to server
      run: |
        ssh botserver "mkdir -p ~/grimlive-backend"
        scp server-rs/target/release/grimlive-server botserver:~/grimlive-backend/
        scp server-rs/.env.example botserver:~/grimlive-backend/.env.example
    
    - name: Restart backend service
      run: |
        ssh botserver << 'EOF'
          cd ~/grimlive-backend
          
          # Stop old backend (Node.js or Rust)
          pm2 stop grimlive-backend || true
          pm2 delete grimlive-backend || true
          
          # Ensure .env exists
          [ ! -f .env ] && cp .env.example .env
          
          # Start new Rust backend with PM2
          pm2 start grimlive-server --name grimlive-backend
          pm2 save
          pm2 list
        EOF
    
    - name: Verify deployment
      run: |
        sleep 5
        curl -f https://api.hystericca.dev/health || exit 1
        echo "✅ Rust backend deployment successful!"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed! Check PM2 logs with: pm2 logs grimlive-backend"
        exit 1
